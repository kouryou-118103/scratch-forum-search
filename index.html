<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>フォーラム検索 | Scratchフォーラムの投稿を検索</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        /* 小さなユーティリティ（Tailwindだけに依存しない部分）*/
        body { transition: background-color 0.25s, color 0.25s; }
        .hidden-section { display: none; }
        .hidden-section.open { display: block; }
        .tooltip-container { position: relative; display:inline-block; }
        .tooltip-text {
            visibility: hidden;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 50;
            margin-top: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.15s, visibility 0.15s;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        .config-btn { display:flex; align-items:center; gap:8px; padding:8px 16px; border-radius:12px; cursor:pointer; transition:all 0.2s; font-weight:700; }
        .config-btn.active { border-color: #3b82f6 !important; color: #3b82f6 !important; }

        .arrow-icon { transition: transform 0.25s ease; }
        .config-btn.active .arrow-icon { transform: rotate(180deg); }

        .input-base { transition: all 0.15s; border: 2px solid transparent; }
        .input-base:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 4px rgba(59,130,246,0.08); }

        @keyframes slideDown { from { opacity:0; transform: translateY(-8px); } to { opacity:1; transform: translateY(0);} }
        .animate-open { animation: slideDown 0.28s ease-out forwards; }

        /* line-clamp の簡易自前実装（Tailwind line-clamp pluginが無くても機能） */
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; white-space: pre-wrap;}

        /* 軽微なレスポンシブ修正 */
        @media (max-width:640px) {
            nav .tooltip-text { left: auto; right: 0; transform: translateX(0);}
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-12 bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100">

    <nav class="max-w-2xl mx-auto flex justify-end items-center gap-5 mb-12">
        <div class="tooltip-container">
            <a href="https://discord.gg/hfpbbCBPFP" target="_blank" rel="noopener noreferrer"
               class="flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 font-bold transition-colors text-sm">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
                Discord
            </a>
            <div class="tooltip-text" role="tooltip">開発サーバーで提案ができる</div>
        </div>

        <a href="https://kouryou-118103.github.io/scratch-forum-search/usage/" target="_blank" rel="noopener noreferrer"
           class="text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 font-bold transition-colors text-sm">使い方</a>
        <a href="https://kouryou-118103.github.io/scratch-forum-search/scratchteam/" target="_blank" rel="noopener noreferrer"
           class="text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 font-bold transition-colors text-sm">To Scratch team</a>

        <button id="theme-toggle" aria-label="テーマ切替" aria-pressed="false"
                class="p-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm hover:scale-105 transition-all text-orange-500 dark:text-yellow-300">
            <!-- 表示は JS で制御 -->
            <svg id="sun-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="5" stroke="currentColor"></circle>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor"></path>
            </svg>
            <svg id="moon-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor"></path>
            </svg>
        </button>
    </nav>

    <main class="max-w-2xl mx-auto">
        <!-- 検索フォームを<form>でラップ -->
        <form id="search-form" class="mb-0" onsubmit="return false;">
            <div class="flex justify-center gap-3 mb-8" role="radiogroup" aria-label="検索タイプ">
                <label for="search-content" class="cursor-pointer">
                    <input type="radio" id="search-content" name="stype" class="hidden peer" checked>
                    <div class="px-5 py-2.5 rounded-xl border-2 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all font-bold text-sm">投稿内容で検索</div>
                </label>
                <label for="search-author" class="cursor-pointer">
                    <input type="radio" id="search-author" name="stype" class="hidden peer">
                    <div class="px-5 py-2.5 rounded-xl border-2 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all font-bold text-sm">投稿者から検索</div>
                </label>
            </div>

            <div class="relative mb-6">
                <label for="keyword" class="sr-only">キーワード</label>
                <input id="keyword" name="q" type="text" placeholder="キーワードを入力..." class="input-base w-full px-6 py-4 rounded-2xl text-lg shadow-lg transition-all" aria-label="検索キーワード">
                <button id="search-btn" type="submit" aria-label="検索" class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-400 hover:text-blue-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </button>
            </div>

            <section class="bg-white dark:bg-slate-800/40 rounded-[28px] p-7 border border-slate-200 dark:border-slate-700/50 shadow-xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-black uppercase tracking-widest text-slate-400 dark:text-slate-500">Advanced Settings</h2>
                    <button id="toggle-settings" class="config-btn text-xs" aria-expanded="false" aria-controls="settings-panel">
                        <svg xmlns="http://www.w3.org/2000/svg" class="arrow-icon h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg>
                        <span id="btn-text">詳細設定を表示</span>
                    </button>
                </div>

                <div id="settings-panel" class="hidden-section space-y-10 mt-8" aria-hidden="true">
                    <div class="flex gap-4">
                        <label for="rule-only" class="flex-1 cursor-pointer">
                            <input type="checkbox" id="rule-only" class="hidden peer">
                            <div class="text-center p-4 rounded-xl border-2 border-slate-200 dark:border-slate-700 text-base font-bold text-slate-500 dark:text-slate-400 peer-checked:border-blue-500 peer-checked:text-blue-600 dark:peer-checked:text-blue-400 transition-all">ルールのみを検索</div>
                        </label>
                        <label for="rule-exclude" class="flex-1 cursor-pointer">
                            <input type="checkbox" id="rule-exclude" class="hidden peer">
                            <div class="text-center p-4 rounded-xl border-2 border-slate-200 dark:border-slate-700 text-base font-bold text-slate-500 dark:text-slate-400 peer-checked:border-red-500 peer-checked:text-red-600 dark:peer-checked:text-red-400 transition-all">ルール投稿を除外</div>
                        </label>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <label class="flex items-center gap-3 p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-700 cursor-pointer group hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                            <input type="checkbox" id="ex-quote" class="w-5 h-5 rounded accent-blue-600" checked>
                            <div>
                                <p class="font-bold text-sm">引用内を検索しない</p>
                                <p class="text-[10px] text-slate-400">返信時の引用文を無視します</p>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-700 cursor-pointer group hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                            <input type="checkbox" id="ex-code" class="w-5 h-5 rounded accent-blue-600">
                            <div>
                                <p class="font-bold text-sm">Code内を検索しない</p>
                                <p class="text-[10px] text-slate-400">[code]タグ内を無視します</p>
                            </div>
                        </label>
                    </div>

                    <div class="space-y-4">
                        <div class="p-5 bg-slate-50 dark:bg-slate-900/40 rounded-2xl border border-slate-100 dark:border-slate-700/50">
                            <label for="check-date" class="flex items-center gap-3 cursor-pointer mb-4">
                                <input type="checkbox" id="check-date" class="w-5 h-5 rounded-md text-blue-600">
                                <span class="text-lg font-bold">日付で絞り込む</span>
                            </label>
                            <div id="box-date" class="hidden-section flex items-center gap-3 ml-8" aria-hidden="true">
                                <label class="sr-only" for="date-from">開始日</label>
                                <input id="date-from" type="date" class="input-base rounded-lg px-3 py-2 text-base">
                                <span class="text-slate-400 font-bold">〜</span>
                                <label class="sr-only" for="date-to">終了日</label>
                                <input id="date-to" type="date" class="input-base rounded-lg px-3 py-2 text-base">
                            </div>
                        </div>

                        <div class="p-5 bg-slate-50 dark:bg-slate-900/40 rounded-2xl border border-slate-100 dark:border-slate-700/50">
                            <label for="check-len" class="flex items-center gap-3 cursor-pointer mb-4">
                                <input type="checkbox" id="check-len" class="w-5 h-5 rounded-md text-blue-600">
                                <span class="text-lg font-bold">投稿文字数で絞り込む</span>
                            </label>
                            <div id="box-len" class="hidden-section flex items-center gap-3 ml-8" aria-hidden="true">
                                <label class="sr-only" for="len-min">最小文字数</label>
                                <input id="len-min" type="number" placeholder="最小" class="input-base rounded-lg px-4 py-2 text-base w-28">
                                <span class="text-slate-400 font-bold">〜</span>
                                <label class="sr-only" for="len-max">最大文字数</label>
                                <input id="len-max" type="number" placeholder="最大" class="input-base rounded-lg px-4 py-2 text-base w-28">
                            </div>
                        </div>
                    </div>

                    <div class="pt-8 border-t border-slate-200 dark:border-slate-700/50 space-y-6">
                        <div class="flex items-center justify-between">
                            <label class="text-lg font-bold" for="per-page">1ページの表示数</label>
                            <select id="per-page" class="input-base rounded-lg px-4 py-2 text-lg font-bold outline-none cursor-pointer">
                                <option value="20">20件</option>
                                <option value="40">40件</option>
                                <option value="60">60件</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
        </form>

        <div id="results-container" class="mt-12 space-y-6" aria-live="polite"></div>
    </main>

    <script>
        // ----- 定数 -----
        const CURRENT_VERSION_ID = "v2026_gen_alpha_01";
        const API_BASE = "https://forumkensaku.kouryou-118103.workers.dev"; // 必要に応じて変更

        // ----- 要素取得 -----
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');

        const configBtn = document.getElementById('toggle-settings');
        const panel = document.getElementById('settings-panel');
        const btnText = document.getElementById('btn-text');

        const searchForm = document.getElementById('search-form');
        const keywordInput = document.getElementById('keyword');
        const searchBtn = document.getElementById('search-btn');
        const resultsContainer = document.getElementById('results-container');

        // helper: エスケープ（念のため）
        function escapeHtml(str) {
            if (str == null) return '';
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        // ----- テーマ制御 -----
        function updateTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                themeToggle.setAttribute('aria-pressed', 'true');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                themeToggle.setAttribute('aria-pressed', 'false');
            }
        }
        // 初期テーマ
        const stored = localStorage.getItem('theme-mode');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        updateTheme(stored === 'dark' || (!stored && prefersDark));

        themeToggle.addEventListener('click', () => {
            const isDark = !document.documentElement.classList.contains('dark');
            updateTheme(isDark);
            localStorage.setItem('theme-mode', isDark ? 'dark' : 'light');
        });

        // ----- 詳細設定トグル -----
        configBtn.setAttribute('aria-expanded', 'false');
        configBtn.addEventListener('click', () => {
            const isOpen = panel.classList.toggle('open');
            panel.setAttribute('aria-hidden', String(!isOpen));
            configBtn.classList.toggle('active', isOpen);
            configBtn.setAttribute('aria-expanded', String(isOpen));
            btnText.innerText = isOpen ? '詳細設定を閉じる' : '詳細設定を表示';
            if (isOpen) {
                panel.classList.add('animate-open');
            } else {
                panel.classList.remove('animate-open');
            }
        });

        // ----- ルールのみ/除外相互排他 -----
        const r1 = document.getElementById('rule-only');
        const r2 = document.getElementById('rule-exclude');
        r1.addEventListener('change', () => { if (r1.checked) r2.checked = false; });
        r2.addEventListener('change', () => { if (r2.checked) r1.checked = false; });

        // ----- 日付 / 文字数表示切替の表示制御 -----
        const setupDisplay = (checkId, boxId) => {
            const ck = document.getElementById(checkId);
            const bx = document.getElementById(boxId);
            const update = () => {
                const open = ck.checked;
                if (open) {
                    bx.classList.add('open');
                    bx.classList.add('animate-open');
                    bx.setAttribute('aria-hidden', 'false');
                } else {
                    bx.classList.remove('open');
                    bx.classList.remove('animate-open');
                    bx.setAttribute('aria-hidden', 'true');
                }
            };
            ck.addEventListener('change', update);
            update();
            return update;
        };
        setupDisplay('check-date', 'box-date');
        setupDisplay('check-len', 'box-len');

        // ----- レンダリング関数（安全に挿入） -----
        function renderResults(results) {
            resultsContainer.innerHTML = '';
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = `<div class="text-center py-20 animate-open"><p class="text-slate-400 font-bold text-lg">該当する投稿は見つかりませんでした。</p></div>`;
                return;
            }
            results.forEach((post, index) => {
                const card = document.createElement('div');
                card.className = `bg-white dark:bg-slate-800/60 p-6 rounded-3xl border border-slate-200 dark:border-slate-700/50 shadow-sm hover:shadow-xl hover:border-blue-400 dark:hover:border-blue-500 transition-all cursor-pointer animate-open`;
                card.style.animationDelay = `${index * 50}ms`;

                const postUrl = `https://scratch.mit.edu/discuss/post/${encodeURIComponent(post.id)}/`;

                // header
                const header = document.createElement('div');
                header.className = 'flex justify-between items-start mb-3';

                const left = document.createElement('div');
                left.className = 'flex items-center gap-2';
                const badge = document.createElement('span');
                badge.className = 'px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-[10px] font-black uppercase rounded-full tracking-wider';
                badge.textContent = post.type || 'POST';
                const date = document.createElement('span');
                date.className = 'text-xs text-slate-400 font-medium';
                date.textContent = post.date || '';
                left.appendChild(badge);
                left.appendChild(date);

                const right = document.createElement('div');
                const a = document.createElement('a');
                a.href = postUrl;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.className = 'text-slate-400 hover:text-blue-500 transition-colors';
                a.setAttribute('aria-label', '元投稿を新しいタブで開く');
                // アイコン
                a.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>';
                // 内部リンクのクリックでカードのクリック伝播を止める
                a.addEventListener('click', (ev) => { ev.stopPropagation(); });

                right.appendChild(a);
                header.appendChild(left);
                header.appendChild(right);

                // title
                const title = document.createElement('h3');
                title.className = 'text-lg font-bold mb-2 text-slate-800 dark:text-slate-100';
                title.textContent = post.title || '無題のトピック';

                // content (安全にテキストとして挿入)
                const content = document.createElement('p');
                content.className = 'text-sm text-slate-500 dark:text-slate-400 line-clamp-3 mb-4 leading-relaxed';
                // 投稿はプレーンテキストで扱う（改行があるなら保持する）
                content.textContent = post.content || '';

                // footer: author
                const footer = document.createElement('div');
                footer.className = 'flex items-center gap-3 pt-4 border-t border-slate-100 dark:border-slate-700/50';
                const avatar = document.createElement('img');
                // avatar パスは環境依存。フォールバック用に onerror 属性を設定。
                avatar.src = `https://uploads.scratch.mit.edu/users/avatars/${encodeURIComponent(post.author_id || 1)}.png`;
                avatar.alt = `${post.author || 'ユーザー'} のアバター`;
                avatar.className = 'w-6 h-6 rounded-full bg-slate-200';
                avatar.addEventListener('error', () => {
                    avatar.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="100%" height="100%" fill="%23e2e8f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="%23808080">U</text></svg>';
                });
                const authorName = document.createElement('span');
                authorName.className = 'text-sm font-bold text-slate-600 dark:text-slate-300';
                authorName.textContent = post.author || '匿名';

                footer.appendChild(avatar);
                footer.appendChild(authorName);

                // assemble
                card.appendChild(header);
                card.appendChild(title);
                card.appendChild(content);
                card.appendChild(footer);

                // カードクリックで新しいタブを開く（内部リンクのイベントで阻止済み）
                card.addEventListener('click', () => window.open(postUrl, '_blank'));

                resultsContainer.appendChild(card);
            });
        }

        // ----- 検索実行 -----
        let ongoing = false;
        async function executeSearch() {
            if (ongoing) return;
            const keyword = keywordInput.value.trim();
            if (!keyword) { alert('キーワードを入力してください。'); keywordInput.focus(); return; }

            ongoing = true;
            searchBtn.disabled = true;
            // ローディング表示
            resultsContainer.innerHTML = `<div class="flex justify-center py-20"><div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full" role="status" aria-hidden="true"></div></div>`;

            // パラメータ作成（真偽値は '1'/'0' に変換）
            const params = new URLSearchParams();
            params.append('q', keyword);
            const stype = document.getElementById('search-author').checked ? 'author' : 'content';
            params.append('type', stype);
            const rule = r1.checked ? 'only' : (r2.checked ? 'exclude' : 'none');
            params.append('rule', rule);
            params.append('exq', document.getElementById('ex-quote').checked ? '1' : '0');
            params.append('exc', document.getElementById('ex-code').checked ? '1' : '0');
            params.append('ds', document.getElementById('check-date').checked ? (document.getElementById('date-from').value || '') : '');
            params.append('de', document.getElementById('check-date').checked ? (document.getElementById('date-to').value || '') : '');
            params.append('lmin', document.getElementById('check-len').checked ? (document.getElementById('len-min').value || '') : '');
            params.append('lmax', document.getElementById('check-len').checked ? (document.getElementById('len-max').value || '') : '');
            params.append('limit', document.getElementById('per-page').value);
            params.append('vid', CURRENT_VERSION_ID);

            try {
                const url = `${API_BASE}?${params.toString()}`;
                const response = await fetch(url, { cache: 'no-cache' });

                if (!response.ok) {
                    // サーバーエラーや404などの詳細を表示
                    const text = await response.text().catch(()=>'');
                    resultsContainer.innerHTML = `<p class="text-red-500 text-center py-10">サーバーエラー: ${response.status} ${escapeHtml(text.slice(0,200))}</p>`;
                    return;
                }

                const data = await response.json().catch(()=>null);
                if (!data) {
                    resultsContainer.innerHTML = `<p class="text-red-500 text-center py-10">レスポンスの解析に失敗しました。</p>`;
                    return;
                }

                if (data.status === 'coming_soon') {
                    resultsContainer.innerHTML = `
                        <div class="max-w-xl mx-auto mt-10 p-8 rounded-[32px] bg-amber-50 dark:bg-amber-900/20 border-2 border-dashed border-amber-200 dark:border-amber-700/50 animate-open">
                            <div class="flex flex-col items-center text-center">
                                <div class="mb-4 p-4 bg-amber-100 dark:bg-amber-800 rounded-2xl text-amber-600 dark:text-amber-400"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                                <h3 class="text-xl font-black text-amber-800 dark:text-amber-200 mb-3 tracking-tighter">Server Offline</h3>
                                <p class="text-sm leading-relaxed text-amber-700 dark:text-amber-300 font-bold">${escapeHtml((data.message||'').replace(/\n/g,' '))}</p>
                            </div>
                        </div>`;
                    return;
                }

                if (data.posts) {
                    renderResults(data.posts);
                } else {
                    renderResults([]);
                }
            } catch (err) {
                console.error(err);
                resultsContainer.innerHTML = `<p class="text-red-500 text-center py-10">エラーが発生しました。${escapeHtml(err.message || '')}</p>`;
            } finally {
                ongoing = false;
                searchBtn.disabled = false;
            }
        }

        // フォーム送信 (Enter でも動く)
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            executeSearch();
        });
        // 検索ボタンクリック
        searchBtn.addEventListener('click', (e) => {
            e.preventDefault();
            executeSearch();
        });

        // Enter 単独のハンドリング（textarea等が無いのでフォーム任せでOK）
        // 初期状態の表示更新（チェックボックスの依存コントロールなど）
        document.addEventListener('DOMContentLoaded', () => {
            // Date / Len ボックスの初期状態は setupDisplay により整えられている
        });
    </script>
</body>
</html>
